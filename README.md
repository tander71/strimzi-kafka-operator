# strimzi-kafka-operator

Install with helm:
------------------

helm repo add strimzi https://strimzi.io/charts/

helm update

kubectl create ns operators

kubectl create ns kafka-project

helm -n operators install strimzi-kafka-operator strimzi/strimzi-kafka-operator --set watchNamespaces="{kafka-project}"

Add topic:
---------

kubectl apply -f examples/topic/kafka-topic.yaml

Add user:
---------

kubectl -n kafka-project apply -f kafka-cluster.yaml

Deploy Kafka-bridge:
-------------------.

kubectl apply -f kafka-bridge.yaml 

Deploy Ingress rule:
--------------------

kubectl apply -f ingress.yaml

Next: port-forward port 8080 to localhost, then:

# Producing messages

curl -X POST \
  http://localhost:8080/topics/my-topic \
  -H 'content-type: application/vnd.kafka.json.v2+json' \
  -d '{
    "records": [
        {
            "key": "key-1",
            "value": "value-1"
        },
        {
            "key": "key-2",
            "value": "value-2"
        }
    ]
}'

YOU SHOULD SEE: 

{ 
   "offsets":[ 
      { 
         "partition":0,
         "offset":0
      },
      { 
         "partition":0,
         "offset":1
      }
   ]
}

# Consuming messages

curl -X POST http://localhost:8080/consumers/my-group \
  -H 'content-type: application/vnd.kafka.v2+json' \
  -d '{
    "name": "my-consumer",
    "format": "json",
    "auto.offset.reset": "earliest",
    "enable.auto.commit": false
  }'

YOU SHOULD SEE:

{ 
   "instance_id":"my-consumer",
   "base_uri":"http://localhost:8080/consumers/my-group/instances/my-consumer"
}

# Subscribing to the topic

curl -X POST http://localhost:8080/consumers/my-group/instances/my-consumer/subscription \
  -H 'content-type: application/vnd.kafka.v2+json' \
  -d '{
    "topics": [
        "my-topic"
    ]
}'

# Consuming messages

curl -X GET http://localhost:8080/consumers/my-group/instances/my-consumer/records \
  -H 'accept: application/vnd.kafka.json.v2+json'

YOU SHOULD SEE:

[ 
   { 
      "topic":"my-topic",
      "key":"key-1",
      "value":"value-1",
      "partition":0,
      "offset":0
   },
   { 
      "topic":"my-topic",
      "key":"key-2",
      "value":"value-2",
      "partition":0,
      "offset":1
   }
]

# Committing offsets

curl -X POST http://localhost:8080/consumers/my-group/instances/my-consumer/offsets \
  -H 'content-type: application/vnd.kafka.v2+json' \
  -d '{
    "offsets": [
        {
            "topic": "my-topic",
            "partition": 0,
            "offset": 2
        }
    ]
}'

# Deleting a consumer

curl -X DELETE http://localhost:8080/consumers/my-group/instances/my-consumer


# OPENSHIFT ROUTE

Exposing on OpenShift using Route
If you are running an OpenShift cluster (for example using Minishift locally), it is possible to expose the Strimzi HTTP bridge using a Route. An OpenShift Route actually works as a Kubernetes Ingress adding features like TLS re-encryption, TLS passthrough, generated pattern-based hostnames and more but it is OpenShift specific. What you need in this case is to create a Route resource as shown in the following snippet.

apiVersion: v1
kind: Route
metadata:
  name: my-bridge-route
spec:
  to:
    kind: Service
    name: my-bridge-bridge-service
  port:
    targetPort: rest-api
The above Route declaration assumes that your bridge instance is named my-bridge so that the corresponding Service, to which the Route will route traffic, is named my-bridge-bridge-service. With the above declaration, the hostname for reaching the bridge will be autogenerated by OpenShift. In order to check its name you can run the oc get routes command.

If you want to specify one, you can do so by setting the spec.host field, so that the snippet will be something like the following.

apiVersion: v1
kind: Route
metadata:
  name: my-bridge-route
spec:
  host: my-bridge.io
  to:
    kind: Service
    name: my-bridge-bridge-service
  port:
    targetPort: rest-api
Finally, instead of creating a Route resource applying the above YAML declaration, it is possible to expose the Strimzi HTTP bridge service through the expose subcommand of the oc tool by running the following command which will create the Route for you.

oc expose service my-bridge-bridge-service

